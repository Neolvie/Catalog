@using System.Globalization
@using Catalog.Model

@model Model
@{
  ViewBag.Title = "Список заданий";
  Layout = "~/Views/Shared/_Layout.cshtml";
}
<head>
    <script src="@Url.Content("~/Scripts/jquery-2.2.3.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/Highcharts-4.0.1/js/highcharts-all.js")" type="text/javascript"></script>
</head>

<div style="margin-top: 20px">
    <span class="h2">Список заданий</span>
</div>

<div class="row">
        <button id="button" onclick="AddRandomAsg()" class="btn btn-success col-md-3">Добавить случайное задание</button>
        <button id="ShowAllAssignments" class="btn btn-default col-md-3">Показать все задания</button>
    <button class="btn btn-info col-md-3" id="MiAButton">Мониторинг и анализ</button>
    <button class="btn btn-danger col-md-3" id="Regenerate">Перегенерировать</button>
</div>

<script>
    $('#MiAButton').click(function() {
        location.href = '@Url.Action("Index", "MiA")';
    });

    $("#ShowAllAssignments").click(function() {
        location.href = '@Url.Action("Index", "AsgList")';
    });

    $("#Regenerate").click(function() {
        location.href = '@Url.Action("RegenerateList", "AsgList")';
    })
</script>

<div class="row">
    <div class="col-md-8">
        <table class="table">
            <thead>
            <tr>
                <th>Ид</th>
                <th>Тема</th>
                <th>Исполнитель</th>
                <th>Срок</th>
                <th>Статус</th>
                <th>Просрочка</th>
            </tr>
            </thead>
            <tbody id="AsgListTable">
            @foreach (var asg in (List<Assignment>) ViewBag.AsgList)
            {
                <tr @(asg.HasOverdue ? "style=background-color:#FFE9DC" : "")>
                    <td>@Html.ActionLink(asg.Id.ToString(), "Index", "Asg", new {id = asg.Id}, null)</td>
                    <td>@asg.Name</td>
                    <td>@Html.ActionLink(asg.Performer.Name, "Index", "Performer", new {id = asg.Performer.Id}, null)</td>
                    <td>@(asg.Deadline?.ToString("dd.MM.yyyy", CultureInfo.CurrentCulture) ?? "-")</td>
                    <td>@asg.Status</td>
                    <td>@(asg.HasOverdue ? asg.Overdue.ToString() : "-")</td>
                </tr>
            }
            </tbody>
        </table>
        @for (var i = 1; i <= ViewBag.AllAsgListCount; ++i)
        {
            if (i == ViewBag.Page)
            {
                <span style="margin: 5px 0 5px 0">@i</span>
            }
            else
            {
                <span style="margin: 5px 0 5px 0">@Html.ActionLink(i.ToString(),
                                               "Index", "AsgList",
                                               new
                                               {
                                                   page = i,
                                                   taskTypeGuid = ViewBag.TaskTypeGuid
                                               }, 
                                               null)</span>
            }
        }
    </div>
    <div class="col-md-4" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">
        @(ViewBag.Chart)
    </div>
</div>

<script>
    function AddRandomAsg() {
        $.get('@Url.Action("GetRandomAsg", "AsgList")', function (asg) {
            $("#newAsg").text = asg;
            if (asg) {
                AddRow(asg);
            }
        });
    }

    function AddRow(asg) {

        var date = new Date(parseInt(asg.Deadline.substr(6)));

        var options = {
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
        };

        var row =
            '<tr' + (asg.HasOverdue ? ' style=\"background-color:#FFE9DC\"' : '\"\"') + '>' +
                '<td><a href=\"/Asg/Index?id=' + asg.Id + '\">' + asg.Id + '</a></td>' +
                '<td>' + asg.Name + '</td>' +
                '<td><a href=\"/Performer/Index?id=' + asg.Performer.Id + '\">' + asg.Performer.Name + '</a></td>' +
                '<td>' + (!asg.Deadline ? '-' : date.toLocaleDateString('ru-RU', options)) + '</td>' +
                '<td>' + asg.Status + '</td>' +
                '<td>' + (asg.HasOverdue ? asg.Overdue : '-') + '</td>' +
                '</tr>';
        $("#AsgListTable").prepend(row);
        $("#AsgListTable tr:last").remove();
    }
</script>